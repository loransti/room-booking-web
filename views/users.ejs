<% title = 'Users' %>
<v-row class="mb-4" align="center" justify="space-between">
  <v-col cols="12" md="6">
    <h2 class="mb-0">Users</h2>
    <div class="text-medium-emphasis">Tap a button to set SOD / Key‑B</div>
  </v-col>
</v-row>

<v-card elevation="0" border="md">
  <v-table density="comfortable">
    <thead>
      <tr>
        <th class="text-left">Name</th>
        <th class="text-left">Username</th>
        <th class="text-left">Telegram ID</th>
        <th class="text-left">Role</th>
        <th class="text-center">SOD</th>
        <th class="text-center">Key‑B</th>
      </tr>
    </thead>
    <tbody>
      <% if (users && users.length) { %>
        <% users.forEach(u => { %>
          <tr>
            <td><%= u.name || '-' %></td>
            <td><%= u.username ? '@' + u.username : '-' %></td>
            <td><code><%= u.tg_id %></code></td>
            <td>
              <v-chip size="small" color="<%= u.role === 'admin' ? 'primary' : 'grey' %>" variant="tonal"><%= u.role %></v-chip>
            </td>
            <td class="text-center">
              <v-btn size="small" color="<%= sodTgId === u.tg_id ? 'success' : 'grey' %>" variant="tonal" onclick="setOpener('sod', <%= u.tg_id %>)" prepend-icon="mdi-key"></v-btn>
            </td>
            <td class="text-center">
              <v-btn size="small" color="<%= keybTgId === u.tg_id ? 'success' : 'grey' %>" variant="tonal" onclick="setOpener('keyb', <%= u.tg_id %>)" prepend-icon="mdi-door-closed"></v-btn>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr><td colspan="6" class="text-center text-medium-emphasis">No users found</td></tr>
      <% } %>
    </tbody>
  </v-table>
  <v-card-text class="text-medium-emphasis">• Green button indicates current holder.</v-card-text>
</v-card>

<script>
  async function setOpener(type, userId) {
    const label = type === 'sod' ? 'SOD' : 'Key‑B';
    if (!confirm(`Set ${label} to user ${userId}?`)) return;
    const res = await fetch('/api/set-opener', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type, userId })
    });
    const data = await res.json();
    if (data.success) {
      location.reload();
    } else {
      alert(data.message || 'Failed to update');
    }
  }
</script>
